<!DOCTYPE html>
<html>
    <head>
    <title>Vue 2.0 Product Curation - Fetch Products</title>

    <style>
        
    
    #header {
        background-color:white;
        color:black;
        text-align:center;
        padding:4px;
        box-shadow: 2px 2px 2px 1px #aaaaaa;
    }
    #instructions {
        width: 500px;
        height: 80px;
        text-align:left;
        background-color: lightcyan;
        box-shadow: 1px 1px 1px #aaaaaa;
    }
    
    #fetchButton {
        width: 200px;
        height: 50px;
        text-align:center;
        font-size: 18px;
        color:white;
        background-color: green;
        box-shadow: 1px 1px 0px #999999;

    }

    
    </style>
    
    
    </head>

    <body onLoad = "readParams()">


        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

        <script>
        var productStatusTag = "CRAWLED";
        var numProducts = 1;
        var request;
        var products = [];
        var otherWindow;
        var myVar;
        var clickedProductId;
        //get tags from server.
        var tagString;
        var tagsrequest;
        var curateProductRequest;
        //for user authentication
        var users = [];
        var curatorID;
        var otherWindowObserver;
        var buttonText;
        //prototype for clear the array values.
        Array.prototype.clear = function() {
            this.length = 0;
        };
        
        function getSelectedProductState() {
            var index = document.getElementById('selectProductState').selectedIndex;
            productStatusTag = document.getElementById('selectProductState').value;
        }

        function getNumProducts() {
            var productIndex = document.getElementById('selectNumProducts').selectedIndex;
            numProducts = document.getElementById('selectNumProducts').value;
        }
        
        function sendMessage(productString) {
            productString = tagString + "##" + productString + "##" + buttonText;
            otherWindow.postMessage(productString, "*");
            clearInterval(myVar)
            otherWindowObserver = setInterval(function() {
                if (otherWindow.closed) {

                    getCurateProduct();
                    clearInterval(otherWindowObserver);
                } else {

                }

            }, 2000)
        }

        function readParams() {
            //ONLY ALLOWED STATIC USER
            //raju ID
            users.push(5505177142427648);
            users.push(6419807607980032);
            //sangeeth ID
            users.push(5769457217568768);
            //Neem 
            users.push(5169874951208960);
            users.push(5649648836411392); //lakshminath's id
            users.push(5638203017003008); //vidya's id

            var srchString = unescape(location.search.substring(1, location.search.length));
            var name = srchString.split("=");
            curatorID = name[1];
            getTags();
            searchString = "CRAWLED";
            numElements = 1;
        }


        function openOther(productString) {
            otherWindow = window.open("source.html", "_blank");
            myVar = setInterval(function() {
                sendMessage(productString)
            }, 1000);
        }

        function getCrawledProducts() {
            var boolval = false;
            for (var i = 0; i < users.length; i++) {
                if (curatorID == users[i])
                    boolval = true;
            }
            if (!boolval) {

                alert("Error: User " + curatorID + " does not exist");
                return;
            }
            var url = "https://vue-server-dev.appspot.com/api/product/search?productstate=" + productStatusTag + "&limit=" + numProducts;
            if (XMLHttpRequest)
            {
                request = new XMLHttpRequest();
                if ("withCredentials" in request)
                {
                    // Firefox 3.5 and Safari 4
                    request.open('GET', url, true);
                    request.onreadystatechange = getHandler;
                    request.send();
                }
            }
        }
        //get result handler
        function getHandler() {
            if (request.readyState != 4)
                return;
            if (request.status == 200)
            {

                var jsonResponse = JSON.parse(request.responseText);
                //clear the old data in array and populate with new product data.
                if (products.length > 0) {
                    document.getElementById("productTableId").innerHTML = "";
                    //return;
                }
                products.clear();
                for (var i = 0; i < jsonResponse.length; i++) {
                    var jsonTempObject = jsonResponse[i];
                    var productObject = {id: jsonTempObject.id, ownerAisleId: jsonTempObject.ownerAisleId, ownerProductListId: jsonTempObject.ownerProductListId,
                        creatorId: jsonTempObject.creatorId, curatorId: jsonTempObject.curatorId, title: jsonTempObject.title, description: jsonTempObject.description,
                        currentProductState: jsonTempObject.currentProductState, relatedProductIds: jsonTempObject.relatedProductIds, productImages: jsonTempObject.productImages,
                        productProviders: jsonTempObject.productProviders, comments: jsonTempObject.comments, productTags: jsonTempObject.productTags, ratings: jsonTempObject.ratings};
                    products.push(productObject);
                }
                prepareTable();
            }
            if (request.status != 200 && request.status != 304) {
                alert('HTTP GET error ' + request.status);
                return;
            }
        }

        //prepare table with received products
        function prepareTable() {
            var table = document.getElementById("productTableId");
            for (var i = 0; i < products.length; i++) {

                if (i % 2 == 0) {
                    var tr = document.createElement("tr");
                    table.appendChild(tr);
                }

                var imag = document.createElement("img");
                
                try {
                    imag.src = products[i].productImages[0].externalURL;
                } catch (e) {
                    imag.src = "assets/noImageAvailable.gif";
                }

                var td = document.createElement("td");
                td.id = products[i].id;
                tr.appendChild(td);
                var divImage = document.createElement("div");
                divImage.appendChild(imag);
                var title = document.createTextNode("Item " + i + ": " + products[i].title);
                var state = document.createTextNode("State:    " + products[i].currentProductState);
                var divTitle = document.createElement("div");
                divTitle.appendChild(title);
                var divState = document.createElement("div");
                divState.appendChild(state);
                td.appendChild(divTitle);
                td.appendChild(divState);
                td.appendChild(divImage);
                td.style.border = "thin solid grey";
                createButton(td, curatethis_product, products[i]);
                
                            }
        }
        
        
        
        function createButton(td, curatethis_product, product) {
                    var button = document.createElement("input");
                    button.type = "button";
                    var archivebutton = document.createElement("input");
                    archivebutton.type = "button";
                    archivebutton.value = "Archive";
                    archivebutton.style.backgroundColor = "white";
                    archivebutton.style.color = "orange";
                    archivebutton.style.outline = "solid orange";
                    
                    if (product.currentProductState == "CRAWLED") {
                        button.value = "Curate Now";
                        button.style.backgroundColor = "white";
                        button.style.color="blue";
                        button.style.outline="thick solid blue";
                        button.style.padding="5px";
                        button.style.margin="12px";
                    } else if (product.currentProductState == "NEEDS_RECURATION") {
                        button.value = "Recurate Now";
                        button.style.backgroundColor = "#B6C6F2";
                        product.currentProductState = "CRAWLED";
                    } else if (product.currentProductState == "CURATED_AND_VERIFIED") {
                        button.style.backgroundColor = "#A8E6B6";
                        button.value = "Verified";
                    } else if (product.currentProductState === "ARCHIVED") {
                        button.style.backgroundColor = "#F1F498";
                        button.value = "Archived";
                    } else {
                        button.value = "Review Now";
                        button.style.backgroundColor = "#059E24";
                    }
                    obj = {
                        handleEvent: function() {

                            clickedProductId = product.id;
                            for (var i = 0; i < products.length; i++) {
                                if (clickedProductId === products[i].id) {
                                    product = products[i];
                                    if (curatorID == null || curatorID == undefined || curatorID.length < 1) {
                                        product.curatorId = "6419807607980032";
                                    } else {
                                        product.curatorId = curatorID;
                                    }
                                    break;
                                }

                            }

                            buttonText = button.value;
                            if (product.currentProductState == "CURATED_AND_VERIFIED") {
                                // alert("already verifed");
                                var productString = JSON.stringify(product)
                                openOther(productString);
                            } else {
                                var productString = JSON.stringify(product)
                                openOther(productString);
                            }

                        },
                        dude: product.title
                    };
                    archiveObj = {
                        handleEvent: function() {
                            var r = confirm("Archiving the product, confirm?");
                            if (r === true) {

                                clickedProductId = product.id;
                                var url = "https://vue-server-dev.appspot.com/api/product/" + product.id;
                                if (XMLHttpRequest) {
                                    curateProductRequest = new XMLHttpRequest();
                                    if ("withCredentials" in curateProductRequest) {
                                        // Firefox 3.5 and Safari 4
                                        curateProductRequest.open('PUT', url, true);
                                        curateProductRequest.setRequestHeader('Custom-Header', 'javascript-client');
                                        curateProductRequest.setRequestHeader('Content-Type', 'application/json');
                                        curateProductRequest.onreadystatechange = curateProductHandler;

//                                //product update request:
                                        curateProductRequest.send(JSON.stringify({id: product.id, ownerAisleId: product.ownerAisleId, ownerProductListId: product.ownerProductListId, creatorId: product.creatorId, curatorId: product.curatorId, title: product.title, description: product.description, currentProductState: "ARCHIVED", relatedProductIds: null, productTags: null, productImages: null, productProviders: null, comments: null, ratings: null}));
                                    } else {

                                    }
                                }
                            }

                        },
                        dude: product.title
                    }
                    button.addEventListener("click", obj, false);
                    archivebutton.addEventListener("click", archiveObj, false);
                    td.appendChild(button);
                    if (product.currentProductState !== "ARCHIVED") {
                        td.appendChild(archivebutton);
                    }
                }
        //on curate button click function
        function curatethis_product() {
            alert("curate product called " + this.name);
        }
        function getTags() {

            var url = "https://vue-server-dev.appspot.com/api/producttags/all";
            if (XMLHttpRequest)
            {
                tagsrequest = new XMLHttpRequest();
                if ("withCredentials" in tagsrequest)
                {
                    // Firefox 3.5 and Safari 4
                    tagsrequest.open('GET', url, true);
                    tagsrequest.onreadystatechange = tagRespnseHandler;
                    tagsrequest.send();
                }
            }
        }
        function tagRespnseHandler() {
            if (tagsrequest.readyState !== 4)
                return;
            if (tagsrequest.status === 200)
            {
                tagString = tagsrequest.responseText;
                var jsonResponse = JSON.parse(tagString);
                var blocked = [];
                for (var k = 0; k < jsonResponse.length; k++) {
                    var tagObject = jsonResponse[k];
                    if (tagObject.tagString.charAt(0) === tagObject.tagString.charAt(0).toLowerCase()) {
                        console.log(tagObject.tagString + " length : " + tagObject.tagString.length);
                        blocked.push(tagObject);
                    }
                }
                for (var i = 0; i < blocked.length; i++) {
                    console.log("Blocked list " + blocked[i].tagString);
                    var t = jsonResponse.indexOf(blocked[i]);
                    if (t !== -1) {
                        jsonResponse.splice(t, 1);
                    }
                }
                tagString = JSON.stringify(jsonResponse);
            }
            if (tagsrequest.status !== 200 && tagsrequest.status !== 304) {
                alert('HTTP GET error ' + tagsrequest.status);
                return;
            }
        }
        function getCurateProduct() {
            var url = "https://vue-server-dev.appspot.com/api/product/" + clickedProductId;
            if (XMLHttpRequest)
            {
                curateProductRequest = new XMLHttpRequest();
                if ("withCredentials" in curateProductRequest)
                {
                    // Firefox 3.5 and Safari 4
                    curateProductRequest.open('GET', url, true);
                    curateProductRequest.onreadystatechange = curateProductHandler;
                    curateProductRequest.send();
                }
            }

        }
        function curateProductHandler() {
            if (curateProductRequest.readyState != 4)
                return;
            if (curateProductRequest.status == 200)
            {

                var curatedProduct = JSON.parse(curateProductRequest.responseText);
                for (var i = 0; i < products.length; i++) {
                    if (clickedProductId === products[i].id) {

                        products[i] = curatedProduct;
                        getAllCellValues();
                        break;
                    }
                }

            }
            if (curateProductRequest.status !== 200 && curateProductRequest.status !== 304) {
                return;
            }

        }
//to refresh the selected product after curation.

        function getAllCellValues() {
            var table = document.getElementById("productTableId");
            var cells = Array.prototype.slice.call(document.getElementById("productTableId").getElementsByTagName("td"));
            var cell;
            for (var i in cells) {
                if (clickedProductId == cells[i].id) {
                    cell = cells[i];
                    var values = cell.getElementsByTagName("div");
                    var titleVal;
                    var stateVal;
                    for (var k = 0; k < products.length; k++) {
                        if (clickedProductId === products[k].id) {
                            titleVal = products[k].title;
                            stateVal = products[k].currentProductState;
                            var button = cell.getElementsByTagName("input");
                            if (stateVal === "CRAWLED") {
                                button[0].style.backgroundColor = "#9C3325";
                                button[0].style.color="white";
                            } else if (stateVal === "NEEDS_RECURATION") {
                                button[0].value = "Recurate Now";
                                button[0].style.backgroundColor = "#9C3325";
                                button[0].style.color="white";
                                products[k].currentProductState = "CRAWLED";
                            } else if (stateVal === "CURATED_AND_VERIFIED") {
                                button[0].style.backgroundColor = "#059E24";
                                button[0].value = "Verified";
                            } else if (stateVal === "ARCHIVED") {
                                button[0].style.backgroundColor = "Orange";
                                button[0].value = "Archived";
                            } else {
                                button[0].style.backgroundColor = "#059E24";
                                button[0].value = "Review Now";
                            }
                            break;
                        }
                    }
                    if (titleVal != undefined && stateVal != undefined) {
                        values[0].innerHTML = "Title : " + titleVal;
                        values[1].innerHTML = "State :  " + stateVal;
                    }

                    break;
                }

            }

        }
        
        
        </script>
        
        <div id="header"><h3>Vue 2.0 Product Curation - Fetch Products</h3></div>

        <div id="instructions">
            <p><br>Fetch CRAWLED products and <font color=blue><b>Curate Now</b></font>;<br>
            <font color=Orange><b>Archive</b></font> products that are not in stock or do not have a product image:
            </p>
        </div>
        <div>
            <p>
            Product State:
            <select id="selectProductState" name="" style="width:150;" onchange="getSelectedProductState();">
                <option value="CRAWLED" title=" ">CRAWLED</option>
                <option value="CURATED" title=" ">CURATED</option>
                <option value="CURATED_AND_VERIFIED" title=" ">CURATED_AND_VERIFIED</option>
                <option value="NEEDS_RECURATION" title=" ">NEEDS_RECURATION</option>
                <option value="ARCHIVED" title=" ">ARCHIVED</option>
            </select>
            <br>
            Number of Products:
            <select id="selectNumProducts" name="" style="width:150;" onchange="getNumProducts();">
                <option value=1 title=" ">One</option>
                <option value=3 title=" ">Few</option>
                <option value=5 title=" ">Several</option>
                <option value=20 title=" ">Many</option>
            </select>
            </p>
            
            <Button id="fetchButton" onclick="getCrawledProducts();" >Fetch Products</Button>
            <p></p>
            
            
        </div>
        
        <table id="productTableId">
        </table>

    </body>
</html>
<style>
    .myButtonRED {
        -moz-box-shadow: inset 0px 39px 0px -24px #e67a73;
        -webkit-box-shadow: inset 0px 39px 0px -24px #e67a73;
        box-shadow: inset 0px 39px 0px -24px #e67a73;
        background-color: #e4685d;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
        border: 1px solid #ffffff;
        display: inline-block;
        cursor: pointer;
        color: #ffffff;
        font-family: arial;
        font-size: 15px;
        padding: 6px 15px;
        text-decoration: none;
        text-shadow: 0px 1px 0px #b23e35;
    }

    #input
    {
        position: absolute;
        top: 0;
        left: 10%;
        z-index: 999;
        padding: 0;
        margin: 0;
    }

    #select
    {
        position: absolute;
        top: 3%;
        left: 10%;
        padding: 0;
        margin: 0;
    }
    argin-top:5px;
    }
</style>

